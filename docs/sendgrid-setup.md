# SendGrid Email Integration Setup

This guide helps you set up SendGrid for sending custom branded password reset emails through Supabase Edge Functions.

## Prerequisites

1. **SendGrid Account**
   - Sign up at [sendgrid.com](https://sendgrid.com)
   - Complete sender verification

2. **Verified Sender Email**
   - Add and verify your sender email/domain in SendGrid
   - Navigate to Settings → Sender Authentication

## Configuration Steps

### 1. Get SendGrid API Key

1. Log into SendGrid Dashboard
2. Go to Settings → API Keys
3. Click "Create API Key"
4. Name: "Blind Nut Password Reset"
5. Permissions: Select "Restricted Access"
   - Enable: Mail Send → Full Access
6. Copy the API key (you won't see it again!)

### 2. Configure Supabase Environment Variables

In your Supabase Dashboard:

1. Go to Settings → Edge Functions
2. Click "Environment Variables"
3. Add the following variables:

```
SENDGRID_API_KEY=SG.your_actual_api_key_here
SENDER_EMAIL=hello@apply.codes
SENDER_NAME=Blind Nut
```

**Important**: Replace values with your actual SendGrid API key and verified sender email.

### 3. Deploy the Edge Function

```bash
# Deploy the send-password-reset function
supabase functions deploy send-password-reset

# Or deploy all functions
supabase functions deploy
```

## Current Implementation & Limitations

### How It Works

1. User requests password reset
2. Frontend calls `send-password-reset` edge function to send branded email
3. Frontend also calls `supabase.auth.resetPasswordForEmail()` to generate the reset token
4. User receives branded email but clicks generic Supabase reset link

### Known Limitations

- **Token Access**: The custom email doesn't have access to the actual reset token generated by Supabase Auth
- **Double Email Risk**: If not handled correctly, users might receive two emails
- **Link Mismatch**: The reset link in the custom email might not match the actual token URL

### Recommended Solution

For a complete custom password reset flow, consider one of these approaches:

#### Option 1: Supabase Auth Hooks (Recommended)
Use Supabase Auth Hooks to intercept the password reset event and send custom emails:

```sql
-- Create auth hook function
CREATE OR REPLACE FUNCTION send_custom_password_reset()
RETURNS trigger AS $$
BEGIN
  -- Call your edge function here
  PERFORM net.http_post(
    url := 'https://your-project.supabase.co/functions/v1/send-password-reset',
    body := json_build_object(
      'email', NEW.email,
      'resetUrl', NEW.confirmation_token
    )::text
  );
  RETURN NEW;
END;
$$ LANGUAGE plpgsql;
```

#### Option 2: Custom Token System
Implement your own password reset token system:

1. Generate secure tokens
2. Store in database with expiration
3. Send custom email with your token
4. Validate token on reset page
5. Update password using admin API

## Testing the Integration

1. **Test SendGrid Connection**:
```bash
# Test the edge function locally
curl -X POST https://your-project.supabase.co/functions/v1/send-password-reset \
  -H "Content-Type: application/json" \
  -d '{
    "email": "test@example.com",
    "resetUrl": "https://apply.codes/reset-password",
    "companyName": "Blind Nut"
  }'
```

2. **Check Supabase Logs**:
   - Go to Supabase Dashboard → Functions → Logs
   - Look for any errors in the send-password-reset function

3. **Verify Email Delivery**:
   - Check SendGrid Activity Feed
   - Confirm email reaches inbox (check spam folder)

## Troubleshooting

### Common Issues

1. **"SendGrid API key not configured"**
   - Ensure SENDGRID_API_KEY is set in Supabase environment variables
   - Redeploy the function after setting variables

2. **"Unauthorized" or 401 errors**
   - Verify SendGrid API key is correct
   - Check API key has Mail Send permissions

3. **Emails not received**
   - Verify sender email is authenticated in SendGrid
   - Check SendGrid activity feed for bounces/blocks
   - Ensure recipient email is valid

4. **CORS errors**
   - Function already includes CORS headers
   - Check if calling from allowed origin

### Debug Commands

```bash
# View function logs
supabase functions logs send-password-reset

# Test function locally
supabase functions serve send-password-reset

# Check environment variables are set
supabase secrets list
```

## Next Steps

1. Consider implementing Auth Hooks for seamless integration
2. Add email templates for other notifications (welcome, etc.)
3. Set up SendGrid webhooks for delivery tracking
4. Implement rate limiting to prevent abuse

## Support

- SendGrid Support: https://support.sendgrid.com
- Supabase Docs: https://supabase.com/docs
- Project Issues: Create issue in GitHub repo